# Default values for app-server.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

global:
  image:
    tag: latest
  subImage:
    tag: ""
  volumes: 
    - name: secrets-volume
      csi:
        driver: secrets-store.csi.k8s.io
        readOnly: true
        volumeAttributes:
          secretProviderClass: app-server
  volumeMounts:
    - name: secrets-volume
      mountPath: "/mnt/secrets-store"
      readOnly: true
  envFrom:
    - secretRef:
        name: app-server
  # envFrom 제거: Secrets Store CSI Driver는 Pod가 CSI volume을 마운트할 때 Secret을 생성합니다.
  # 하지만 envFrom은 Pod 시작 전에 Secret이 필요하므로 순환 참조가 발생합니다.
  # 애플리케이션은 /mnt/secrets-store 경로에서 직접 환경 변수를 읽어야 합니다.

replicaCount: 1
revisionHistoryLimit: 3

image:
  repository: svvwac98/ezl-app-server-python
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: ""

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Automatically mount a ServiceAccount's API credentials?
  automount: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

podAnnotations: {}
podLabels: {}

podSecurityContext: {}
  # fsGroup: 2000

securityContext: {}
  # capabilities:
  #   drop:
  #   - ALL
  # readOnlyRootFilesystem: true
  # runAsNonRoot: true
  # runAsUser: 1000

service:
  type: ClusterIP
  port: 8000

ingress:
  enabled: false
  className: ""
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "5m"
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  hosts:
    - host: chart-example.local
      path: /
      pathType: ImplementationSpecific
      whitelist:
        - 0.0.0.0/0
      denylist:
        - 192.168.0.1
  tls: []
  #  - secretName: chart-example-tls
  #    hosts:
  #      - chart-example.local

# AWS ALB Ingress Controller 설정
alb:
  enabled: false
  className: alb
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing  # internet-facing 또는 internal
    alb.ingress.kubernetes.io/target-type: ip          # ip 또는 instance
    alb.ingress.kubernetes.io/group.name: ezl-app-alb-group  # ALB 공유를 위한 그룹 이름
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: "443"
    # Host 헤더 보존 (클라이언트 요청의 원본 Host 헤더를 백엔드로 전달)
    alb.ingress.kubernetes.io/load-balancer-attributes: preserve_host_header.enabled=true
    # Host을 옮바르게 적었을 경우 인증서 디스커버리를 통해 할당됨으로 굳이 명시하지 않아도됨
    # ref: https://kubernetes-sigs.github.io/aws-load-balancer-controller/latest/guide/ingress/cert_discovery/
    # alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:region:account:certificate/xxx
    
    # alb.ingress.kubernetes.io/healthcheck-path: /health
    # alb.ingress.kubernetes.io/healthcheck-interval-seconds: "15"
    # alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "5"
    # alb.ingress.kubernetes.io/healthy-threshold-count: "2"
    # alb.ingress.kubernetes.io/unhealthy-threshold-count: "2"
    # alb.ingress.kubernetes.io/success-codes: "200"
    # alb.ingress.kubernetes.io/group.order: "1"
  # whitelist:
  #   - 58.239.25.4/32
  #   - 10.0.0.0/8
  hosts:
    - host: chart-example.local
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - hosts:
  #      - chart-example.local
  #    secretName: chart-example-tls  # ACM 사용 시 secretName 불필요

resources: {}
  # We usually recommend not to specify default resources and to leave this as a conscious
  # choice for the user. This also increases chances charts run on environments with little
  # resources, such as Minikube. If you do want to specify resources, uncomment the following
  # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
  # limits:
  #   cpu: 100m
  #   memory: 128Mi
  # requests:
  #   cpu: 100m
  #   memory: 128Mi

# startupProbe:
#   httpGet:
#     path: /api/intgapp/ping/
#     port: 8000
#   failureThreshold: 10
#   initialDelaySeconds: 20
#   periodSeconds: 5
#   timeoutSeconds: 60
# livenessProbe:
#   httpGet:
#     path: /api/intgapp/ping/
#     port: 8000
#   failureThreshold: 3
#   periodSeconds: 5
#   timeoutSeconds: 60
# readinessProbe:
#   httpGet:
#     path: /api/intgapp/ping/
#     port: 8000
#   failureThreshold: 3
#   periodSeconds: 5
#   timeoutSeconds: 60

# KEDA 기반 오토스케일링 설정
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 10
  pollingInterval: 10  # 감시하는 주기 (초)
  cooldownPeriod: 60  # 쿨다운 주기 (초)
  triggers:
    cpu:
      enabled: false
      targetUtilization: "80"
    memory:
      enabled: false
      targetUtilization: "80"
    rps:
      enabled: false
      targetRPS: "10"
    api:
      enabled: false
  # #Cron 기반 스케일링 (여러 개 설정 가능)
  # cron:
  #   # 1. 매월 20일 오전 10시부터 16시까지 운영계 앱서버 최소 파드 수가 7개로 조정되어야한다
  #   - name: "monthly-20events"
  #     timezone: "Asia/Seoul"
  #     start: "0 10 20 * *"   
  #     end: "0 16 20 * *"
  #     desiredReplicas: 7  

# Additional volumes on the output Deployment definition.
volumes: []

# Additional volumeMounts on the output Deployment definition.
volumeMounts: []

nodeSelector: {}

tolerations: []

affinity: {}

# Python 앱은 자체적으로 실행되므로 command/args 불필요
# command:
# - python
# args:
# - app.py

secret:
  secretName: sample/app
  secretKey:
  - DB_PASSWORD
  - DB_HOST
  - DB_NAME
  - DB_USER
  - DB_PORT
  
# work-queue:
#   serviceAccount:
#     name: app-server
#   command:
#     - celery
#     - -A
#     - ezl_app_server
#     - worker
#     - --loglevel=info
#     - --concurrency=1
#   enabled: true
# celery-beat:
#   serviceAccount:
#     name: app-server
#   command:
#     - celery
#     - -A
#     - ezl_app_server
#     - beat
#     - --loglevel=info
#   enabled: true
# sqs-poller:
#   serviceAccount:
#     name: app-server
#   command:
#     - python
#     - manage.py
#     - sqs_poller
#   enabled: true